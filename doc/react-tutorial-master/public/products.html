<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>React Tutorial</title>
    <!-- Not present in the tutorial. Just for basic styling. -->
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/products.css" />
    <script src="https://npmcdn.com/react@15.3.0/dist/react.js"></script>
    <script src="https://npmcdn.com/react-dom@15.3.0/dist/react-dom.js"></script>
    <script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
    <script src="https://npmcdn.com/jquery@3.1.0/dist/jquery.min.js"></script>
    <script src="https://npmcdn.com/remarkable@1.6.2/dist/remarkable.min.js"></script>
</head>
<body>
<div id="content"></div>
<!--<script type="text/babel" src="scripts/example.js"></script>-->
<!--<script type="text/babel" src="scripts/tutorial8.js"></script>-->
<script type="text/babel">

    var maxId = 0;

    var ProductRow = React.createClass({
        render: function() {
            var name = this.props.stocked ?
                    this.props.name :
            <span style={{color: 'red'}}>{this.props.name} (out of stock)</span>;
            return (
                    <tr>
                        <td>{this.props.id}</td>
                        <td>{name}</td>
                        <td>{this.props.price}</td>
                    </tr>
            );
        }
    });

    var ProductCategoryRow = React.createClass({
        render: function() {
            return (<tr><th className="columnHead" colSpan="3">Category: <span style={{color: 'blue'}}>{this.props.category}</span></th></tr>);
        }
    });

    var ProductHeaderRow = React.createClass({
        render: function() {
            return (<tr>
                        <th className="tableHead">Product Id</th>
                        <th className="tableHead">Product Name</th>
                        <th className="tableHead">Unit Price</th>
                    </tr>);
        }
    });

    /* This is the main object */
    var ProductBox = React.createClass({
        loadPropertiesFromServer: function() {
            $.ajax({
                url: this.props.url,
                dataType: 'json',
                cache: false,
                success: function(data) {
                    this.setState({data: data});
                }.bind(this),
                error: function(xhr, status, err) {
                    console.error(this.props.url, status, err.toString());
                }.bind(this)
            });
        },

        handleProductSubmit: function(product) {
            var products = this.state.data;
            // Optimistically set an id on the new comment. It will be replaced by an
            // id generated by the server. In a production application you would likely
            // not use Date.now() for this and would have a more robust system in place.
            //product.id = 99; //Date.now(); //NO
            product.id = this.getNewProductId;
            product.stocked = false;
            //product.category = "Placeholder";
            //product.price = "$99.99";
            //product.author = "test";
            //product.text = "test";
            var newProducts = products.concat([product]);
            this.setState({data: newProducts});
            //submit to server and refresh the list
            $.ajax({
                url: this.props.url,
                dataType: 'json',
                type: 'POST',
                data: product,
                success: function(data) {
                    this.setState({data: data});
                }.bind(this),
                error: function(xhr, status, err) {
                    this.setState({data: products});
                    console.error(this.props.url, status, err.toString());
                }.bind(this)
            });
        },

        getInitialState: function() {
            return {data: []};
        },

        componentDidMount: function() {
            this.loadPropertiesFromServer();
            setInterval(this.loadPropertiesFromServer, this.props.pollInterval);
        },

        getNewProductId: function() {
            var nextid = maxId + 1;
            return nextid;
        },

        render: function() {
            return (
                    <div className="productBox">
                    <h1>My Products</h1>

                    <ProductList data={this.state.data} />

                    <br/>

                    <ProductForm onProductSubmit={this.handleProductSubmit} />

                    </div>
            );
        }
    });

    var ProductList = React.createClass({
        render: function() {
            var rows = [];
            var lastCategory = null;
            var headerRow = null;

            this.props.data.forEach(function(product) {

                /*if (product.name.indexOf(this.props.filterText) === -1 || (!product.stocked && this.props.inStockOnly)) {
                    return;
                }*/
                if (headerRow == null) {
                    rows.push(<ProductHeaderRow key="product_header"/>);
                    headerRow = 1;
                }
                if (product.category !== lastCategory) {
                    rows.push(<ProductCategoryRow category={product.category} key={product.category} />);
                }

                rows.push(
                    <ProductRow key={product.id} id={product.id} name={product.name} price={product.price}
                    stocked={product.stocked} category={product.category}>
                        {product.id}
                        {product.name}
                        {product.price}
                        {product.stocked}
                        {product.category}
                    </ProductRow>
                );
                lastCategory = product.category;
                if (maxId < product.id) {
                    maxId = product.id;
                }
            }.bind(this));
             return (
                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                <th></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>{rows}</tbody>
                    </table>
             );
        }
    });

    var ProductForm = React.createClass({
        getInitialState: function() {
            return {name: '', category: '', price: ''};
        },

        handleCategoryChange: function(e) {
            this.setState({category: e.target.value});
        },

        handleNameChange: function(e) {
            this.setState({name: e.target.value});
        },

        handlePriceChange: function(e) {
            this.setState({price: e.target.value});
        },

        handleSubmit: function(e) {
            e.preventDefault();
            var name = this.state.name.trim();
            var category = this.state.category.trim();
            var price = this.state.price.trim();
            //var nextid = this.state.maxid.trim() + 1;
            //alert(nextid);
            if (!category || !name || !price) {
                alert("!");
                return;
            }
            this.props.onProductSubmit({name: name, category: category, price: price}); //set the properties
            this.setState({name: '', category: '', price: ''});
        },

        render: function() {
            return (
                    <form className="productForm" onSubmit={this.handleSubmit}>
                        <h3>Add New Product</h3>
                        <input
                            type="text"
                            placeholder="Product Category"
                            value={this.state.category}
                            onChange={this.handleCategoryChange}
                        />
                        <input
                            type="text"
                            placeholder="Product Name"
                            value={this.state.name}
                            onChange={this.handleNameChange}
                        />
                        <input
                            type="text"
                            placeholder="Price"
                            value={this.state.price}
                            onChange={this.handlePriceChange}
                        />
                        <input type="submit" value="Post" />
                        <select multiple={false} value={['Electronics', 'Sporting Goods']} />
                    </form>
            );
        }
    });

    /*var SearchBar = React.createClass({
        handleChange: function() {
            this.props.onUserInput(
                    this.refs.filterTextInput.value,
                    this.refs.inStockOnlyInput.checked
            );
        },

        render: function() {
            return (
                    <form>
                        <input
                            type="text"
                            placeholder="Search..."
                            value={this.props.filterText}
                            ref="filterTextInput"
                            onChange={this.handleChange}
                        />
                        <input
                            type="checkbox"
                            checked={this.props.inStockOnly}
                            ref="inStockOnlyInput"
                            onChange={this.handleChange}
                        />
                        {' '}
                        Only show products in stock
                    </form>
            );
        }
    });*/

    /*var FilterableProductTable = React.createClass({
        getInitialState: function() {
            return {
                filterText: '',
                inStockOnly: false
            };
        },

        handleUserInput: function(filterText, inStockOnly) {
            this.setState({
                filterText: filterText,
                inStockOnly: inStockOnly
            });
        },

        render: function() {
            return (
                    <div>
                        <SearchBar
                            filterText={this.state.filterText}
                            inStockOnly={this.state.inStockOnly}
                            onUserInput={this.handleUserInput}
                        />
                        <ProductBox
                            products={this.props.url}
                            filterText={this.state.filterText}
                            inStockOnly={this.state.inStockOnly}
                        />
                    </div>
            );
        }
    });*/

    ReactDOM.render(
     <ProductBox url="/api/products" pollInterval={15000} />,
     document.getElementById('content')
     );

</script>
</body>
</html>
